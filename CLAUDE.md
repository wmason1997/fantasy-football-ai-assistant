# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Fantasy Football AI Assistant - An intelligent application providing data-driven trade recommendations, automated waiver wire optimization, real-time injury monitoring with auto-substitution, and learned opponent tendency analysis.

**Target Launch:** August 2026 (before 2026 NFL season)
**Primary User:** Competitive Fantasy Football players in 10-14 team leagues

## Technology Stack

### Frontend
- **Web:** Next.js 14+ (TypeScript, React Server Components)
- **Mobile (Phase 2):** React Native with Expo
- **State Management:** Zustand or React Query
- **UI:** Tailwind CSS with shadcn/ui components
- **Real-time:** Socket.io client

### Backend
- **API Server:** Node.js with Express/Fastify (TypeScript)
- **Compute Services:** Rust microservices for:
  - Trade evaluation algorithms
  - Waiver wire ranking calculations
  - Historical data processing
- **Real-time Monitoring:** Node.js with WebSocket server
- **Task Scheduling:** Bull/BullMQ for weekly waiver processing

### Data Layer
- **Primary Database:** PostgreSQL 15+ (with TimescaleDB extension)
  - User accounts, league configurations
  - Historical transactions and decisions
  - Learned opponent profiles
- **Cache:** Redis
  - Player projections and stats (short TTL)
  - Rate limiting for external APIs
  - Session management

### Infrastructure
- **Hosting:** Vercel (frontend) + Railway/Render (backend services)
- **Push Notifications:** Firebase Cloud Messaging (FCM)
- **Monitoring:** Sentry (error tracking), Datadog/Grafana (metrics)
- **CI/CD:** GitHub Actions

## External API Integrations

### Primary Fantasy Platform: Sleeper API (MVP)
- **Base URL:** `https://api.sleeper.app/v1/`
- **Authentication:** None required for read operations
- **Rate Limits:** ~1000 requests/minute
- **Key Endpoints:**
  - `/league/{league_id}` - League settings, scoring
  - `/league/{league_id}/rosters` - All rosters
  - `/league/{league_id}/transactions/{week}` - Trades, waivers, adds/drops
  - `/league/{league_id}/matchups/{week}` - Weekly matchups
  - `/players/nfl` - Complete player database (updated daily)

### Data Refresh Strategy
- **Player Projections:** Daily at 3 AM ET (Redis TTL: 24 hours)
- **Injury Status:**
  - Every 2 minutes during game windows (Thu 6PM-11PM, Sun 12PM-11PM, Mon 6PM-11PM ET)
  - Every 30 minutes otherwise
  - Redis TTL: 2 minutes during games, 1 hour otherwise
- **League Rosters:** Every 15 minutes during season (Redis TTL: 15 minutes)
- **Transactions History:** Weekly after waivers clear (PostgreSQL, no cache)

## Database Architecture

### Core Concepts
- **Users** → **Leagues** (1:many) → **Rosters** (1:many)
- **Players** master table synced from Sleeper API
- **Transactions** append-only audit log
- **Trade/Waiver Recommendations** generated by AI
- **Opponent Profiles** learned over time via Bayesian updates
- **Injury Alerts** log for notification tracking

### Key Indexes
Performance-critical indexes on:
- `rosters(league_id)`
- `transactions(league_id, week, season)`
- `player_projections(player_id, week, season)`
- `players(status)` for injury monitoring
- `injury_alerts(game_time)` for pending alerts

## Core Features

### 1. Trade Analyzer
**Algorithm Flow:**
1. Identify sell-high candidates (performing >15% above projection)
2. Identify buy-low targets across league (undervalued by >20%)
3. Generate 1-for-1, 2-for-1, 2-for-2 packages
4. Score fairness and acceptance probability using opponent profiles
5. Return top 5 recommendations per week

**Opponent Learning:** Bayesian updates to position preferences, risk tolerance, and trade patterns based on historical transactions.

### 2. Waiver Wire Optimization
**Algorithm Flow:**
1. Identify high-value targets (opportunityScore > 0.3)
2. Analyze roster positional needs
3. Calculate optimal FAAB bid based on:
   - Historical league bidding patterns
   - Player value and opportunity change
   - Positional need multiplier
   - Add trend urgency
4. Never recommend >40% of remaining budget

**For Waiver Priority Leagues:** Rank claims by composite score of projected ROS points, opportunity, and positional need.

### 3. Real-Time Injury Monitoring
**Monitoring Windows:**
- Start monitoring 2 hours before each game
- Poll every 2 minutes when <30 min to kickoff
- Poll every 1 minute when <30 min to kickoff

**Alert Flow:**
1. Detect status change to "Out" within 10 minutes of kickoff
2. Find best bench replacement (hasn't played, highest projection, later game time)
3. Send push notification with urgency level
4. Log alert in `injury_alerts` table
5. Auto-substitute if user has preference enabled

## Development Phases

### Phase 1 - MVP (Target: April 2026)
- User auth & Sleeper league connection
- Trade analyzer with sell-high/buy-low
- Waiver wire targets with FAAB recommendations
- Basic opponent modeling (position preferences)
- Web application only

### Phase 2 - Real-Time (Target: June 2026)
- Injury monitoring service
- Push notifications (FCM)
- Auto-substitution recommendations
- Mobile app beta

### Phase 3 - Launch (Target: August 2026)
- ESPN API integration
- Advanced Rust ML models
- League insights dashboard
- Beta testing & polish

## Key Algorithms

### Trade Value Calculation
- **Performance Ratio:** `avgActualPoints / avgProjectedPoints`
- Sell-high threshold: ratio > 1.15 AND z-score > 0.5
- Buy-low threshold: currentValueDiscount > 0.2 AND injuryRisk < 0.3
- Fairness score must be >0.6 for recommendation
- Acceptance probability must be >0.25

### FAAB Bid Calculation
```
baseBid = medianHistoricalBid
baseBid *= (1 + opportunityScore * 0.5)  // value adjustment
baseBid *= (1 + positionalNeed * 0.3)     // need adjustment
if (addTrend > 20) baseBid *= 1.2         // urgency adjustment
maxBid = min(baseBid, currentFAAB * 0.4)
```

### Opponent Profile Updates
Exponential moving average for position preferences:
```
newPref = currentPref * 0.8 + (1.0 * 0.2)
```

Trade acceptance rate:
```
acceptanceRate = acceptedTrades / totalTrades
```

Risk tolerance updated per transaction based on player types acquired.

## Important Constraints

### API Limitations
- **Write Operations:** Cannot execute trades or waiver claims via API
  - App must deep-link to platform for user to manually submit
  - Track user action (sent/dismissed) for learning
- **Rate Limiting:** Respect Sleeper's ~1000 req/min limit
- **Real-time Data:** Use WebSocket when available, polling as fallback

### Security & Privacy
- Never store platform passwords (OAuth when available)
- Encrypt sensitive data at rest
- Row-level security in database
- Clear that app is read-only advisor, not executor

### Cost Optimization
- Intelligent polling (slow when far from events, fast when near)
- Aggressive caching with appropriate TTLs
- Serverless functions for game-window monitoring
- Estimated monthly cost during season: $50-85

## Testing Requirements

- Test coverage target: >70% for MVP
- Critical paths to test:
  - League connection and sync
  - Trade recommendation generation
  - Waiver bid calculation
  - Injury alert delivery
  - Opponent profile updates

## Project Structure (To Be Created)

```
/frontend          # Next.js web application
/backend           # Node.js API server
/rust-compute      # Rust microservices
/mobile            # React Native (Phase 2)
/shared            # Shared TypeScript types
/database          # Migrations and schema
```

## Refer to PRD

For detailed specifications on:
- Complete database schema (fantasy-football-ai-prd.md sections 3.1-3.2)
- Detailed algorithm pseudo-code (sections 4.1-4.3)
- API endpoint specifications (throughout section 4)
- UI/UX flows (sections 4.1.3, 4.2.3, 4.3.3)
- Game window monitoring schedule (section 4.3.4)
- Learning system details (section 4.4)
