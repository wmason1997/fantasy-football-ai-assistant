// Prisma schema for Fantasy Football AI Assistant

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users & Authentication
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  lastLogin DateTime?
  pushToken String?  @db.VarChar(500)

  // JSON field for notification preferences
  notificationPreferences Json @default("{\"injuryAlerts\": true, \"tradeSuggestions\": true, \"waiverReminders\": true, \"autoSubstitute\": false}")

  // Relations
  leagues League[]

  @@map("users")
}

// Connected Fantasy Leagues
model League {
  id               String   @id @default(uuid())
  userId           String
  platform         String   @db.VarChar(20) // 'sleeper', 'espn', 'yahoo'
  platformLeagueId String   @db.VarChar(100)
  leagueName       String?  @db.VarChar(200)
  teamName         String?  @db.VarChar(200)
  platformTeamId   String?  @db.VarChar(100)
  scoringSettings  Json?
  rosterSettings   Json?
  faabBudget       Int?
  currentFaab      Int?
  waiverPriority   Int?
  isActive         Boolean  @default(true)
  lastSynced       DateTime?
  createdAt        DateTime @default(now())

  // Relations
  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  rosters               Roster[]
  transactions          Transaction[]
  tradeRecommendations  TradeRecommendation[]
  opponentProfiles      OpponentProfile[]
  waiverRecommendations WaiverRecommendation[]
  injuryAlerts          InjuryAlert[]

  @@unique([platform, platformLeagueId, platformTeamId])
  @@index([userId])
  @@map("leagues")
}

// Player Master Data (synced from APIs)
model Player {
  id               String   @id @db.VarChar(50) // platform player ID
  fullName         String   @db.VarChar(200)
  position         String   @db.VarChar(10)
  team             String?  @db.VarChar(10) // NFL team abbreviation
  status           String?  @db.VarChar(20) // 'Active', 'Out', 'Questionable', etc.
  injuryDesignation String? @db.VarChar(100)
  byeWeek          Int?
  lastUpdated      DateTime @default(now())
  metadata         Json?

  // Relations
  rosters     Roster[]
  projections PlayerProjection[]

  @@index([status])
  @@map("players")
}

// User's Current Roster (denormalized for performance)
model Roster {
  id             String   @id @default(uuid())
  leagueId       String
  playerId       String
  rosterSlot     String   @db.VarChar(20) // 'QB', 'RB', 'FLEX', 'BN', etc.
  isStarting     Boolean  @default(false)
  acquiredDate   DateTime?
  acquisitionCost Int?    // FAAB spent or NULL

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id])

  @@unique([leagueId, playerId])
  @@index([leagueId])
  @@map("rosters")
}

// League Transactions (append-only audit log)
model Transaction {
  id                    String   @id @default(uuid())
  leagueId              String
  transactionType       String   @db.VarChar(20) // 'trade', 'waiver', 'free_agent'
  week                  Int
  season                Int
  involvedTeams         Json // array of team IDs
  playersMoved          Json // [{player_id, from_team, to_team, faab_cost}]
  proposerTeamId        String?  @db.VarChar(100)
  status                String   @db.VarChar(20) // 'proposed', 'accepted', 'rejected', 'completed'
  proposedAt            DateTime?
  completedAt           DateTime?
  platformTransactionId String?  @db.VarChar(100)
  metadata              Json?

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId, week, season])
  @@map("transactions")
}

// Player Projections (weekly fantasy point projections)
model PlayerProjection {
  id          String   @id @default(uuid())
  playerId    String
  week        Int      // 0 for season-long, 1-18 for weekly
  season      Int
  projectedPoints Float

  // Position-specific stats (flexible JSON structure)
  // QB: {passingYards, passingTDs, interceptions, rushingYards, rushingTDs}
  // RB/WR/TE: {rushingYards, rushingTDs, receptions, receivingYards, receivingTDs, targets}
  // K: {fieldGoalsMade, fieldGoalsAttempted, extraPointsMade}
  // DST: {sacks, interceptions, fumblesRecovered, safeties, touchdowns, pointsAllowed}
  stats       Json?

  // Confidence interval for projection accuracy
  confidence  Float?   @default(0.5) // 0.0 to 1.0

  // Source of projection (for tracking which model/API it came from)
  source      String   @db.VarChar(50) @default("sleeper") // 'sleeper', 'espn', 'internal_ml', etc.

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, week, season, source])
  @@index([playerId, week, season])
  @@index([week, season])
  @@map("player_projections")
}

// Trade Recommendations (AI-generated trade suggestions)
model TradeRecommendation {
  id                String   @id @default(uuid())
  leagueId          String
  week              Int
  season            Int

  // Trade package details
  myPlayers         Json     // [{playerId, playerName, position, currentValue, projectedValue}]
  targetPlayers     Json     // [{playerId, playerName, position, currentValue, projectedValue}]
  targetTeamId      String   @db.VarChar(100)
  targetTeamName    String?  @db.VarChar(200)

  // Trade analysis scores
  fairnessScore     Float    // 0.0 to 1.0 (>0.6 recommended)
  acceptanceProbability Float // 0.0 to 1.0 (>0.25 recommended)
  myValueGain       Float    // Expected value gain for my team
  targetValueGain   Float    // Expected value gain for target team

  // Trade type and reasoning
  tradeType         String   @db.VarChar(20) // '1-for-1', '2-for-1', '2-for-2'
  reasoning         String   @db.Text // Human-readable explanation
  sellHighPlayers   Json?    // Players I'm selling high
  buyLowPlayers     Json?    // Players I'm buying low

  // Recommendation metadata
  confidence        Float    @default(0.5)
  priority          Int      @default(0) // Higher = more recommended
  status            String   @db.VarChar(20) @default("pending") // 'pending', 'sent', 'accepted', 'rejected', 'dismissed'

  // User tracking
  viewedAt          DateTime?
  sentAt            DateTime?
  respondedAt       DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId, week, season])
  @@index([leagueId, status])
  @@index([week, season])
  @@map("trade_recommendations")
}

// Opponent Profiles (learned opponent tendencies)
model OpponentProfile {
  id                  String   @id @default(uuid())
  leagueId            String
  opponentTeamId      String   @db.VarChar(100)
  opponentTeamName    String?  @db.VarChar(200)

  // Position preferences (learned via Bayesian updates)
  // Higher value = stronger preference for that position
  qbPreference        Float    @default(0.5)
  rbPreference        Float    @default(0.5)
  wrPreference        Float    @default(0.5)
  tePreference        Float    @default(0.5)

  // Trade behavior patterns
  riskTolerance       Float    @default(0.5) // 0.0 = risk-averse, 1.0 = risk-seeking
  tradingActivity     Float    @default(0.5) // 0.0 = rarely trades, 1.0 = very active
  acceptanceRate      Float    @default(0.3) // Ratio of accepted to proposed trades

  // Historical statistics
  totalTradesProposed Int      @default(0)
  totalTradesAccepted Int      @default(0)
  totalTradesRejected Int      @default(0)
  totalTradesInitiated Int     @default(0)

  // Learned preferences
  prefersStars        Boolean  @default(false) // Prefers fewer high-value players
  prefersDepth        Boolean  @default(false) // Prefers more lower-value players
  valuesSafety        Boolean  @default(true)  // Avoids injury-prone players

  // Last analysis metadata
  lastUpdated         DateTime @default(now())
  lastTradeDate       DateTime?
  dataPoints          Int      @default(0) // Number of transactions analyzed

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, opponentTeamId])
  @@index([leagueId])
  @@map("opponent_profiles")
}

// Waiver Wire Recommendations (AI-optimized waiver claims)
model WaiverRecommendation {
  id                  String   @id @default(uuid())
  leagueId            String
  week                Int
  season              Int

  // Player details
  playerId            String
  playerName          String   @db.VarChar(200)
  position            String   @db.VarChar(10)
  team                String?  @db.VarChar(10)

  // Opportunity metrics
  opportunityScore    Float    // 0.0 to 1.0 (>0.3 recommended)
  projectedPoints     Float    // ROS projection
  recentPerformance   Float    // Last 3 weeks average
  targetShare         Float?   // For WR/TE
  snapShare           Float?   // Playing time percentage
  injuryImpact        Boolean  @default(false) // Benefiting from teammate injury

  // Roster analysis
  positionalNeed      Float    // 0.0 to 1.0 (1.0 = critical need)
  wouldStartImmediately Boolean @default(false)
  benchDepthScore     Float    // How much this improves bench

  // FAAB bid calculation (for FAAB leagues)
  recommendedBid      Int?     // Recommended FAAB amount
  minBid              Int?     // Minimum to be competitive
  maxBid              Int?     // Maximum reasonable bid
  medianHistoricalBid Int?     // League average for similar adds
  addTrendPercentage  Float?   // % of leagues adding this player

  // Waiver priority (for non-FAAB leagues)
  priorityRank        Int      @default(0) // 1 = highest priority claim
  shouldClaim         Boolean  @default(false)

  // Drop candidate
  suggestedDropPlayerId   String?
  suggestedDropPlayerName String?  @db.VarChar(200)
  dropPlayerValue         Float?

  // Recommendation metadata
  reasoning           String   @db.Text
  confidence          Float    @default(0.5)
  urgency             String   @db.VarChar(20) @default("medium") // 'low', 'medium', 'high', 'critical'

  // User tracking
  status              String   @db.VarChar(20) @default("pending") // 'pending', 'claimed', 'missed', 'dismissed'
  viewedAt            DateTime?
  claimedAt           DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId, week, season])
  @@index([leagueId, status])
  @@index([playerId])
  @@map("waiver_recommendations")
}

// Injury Alerts (real-time monitoring and notifications)
model InjuryAlert {
  id                String   @id @default(uuid())
  leagueId          String
  week              Int
  season            Int

  // Injured player details
  injuredPlayerId   String
  injuredPlayerName String   @db.VarChar(200)
  position          String   @db.VarChar(10)
  team              String?  @db.VarChar(10)

  // Injury information
  previousStatus    String   @db.VarChar(20) // Status before injury
  newStatus         String   @db.VarChar(20) // Current status (usually 'Out')
  injuryDesignation String?  @db.VarChar(100)

  // Game information
  gameTime          DateTime // Scheduled game kickoff time
  gameId            String?  @db.VarChar(100)
  opponent          String?  @db.VarChar(10)

  // Timing
  detectedAt        DateTime @default(now())
  minutesToKickoff  Int      // Minutes remaining until kickoff when detected
  isUrgent          Boolean  @default(false) // <10 minutes to kickoff

  // Substitution recommendation
  recommendedSubPlayerId   String?
  recommendedSubPlayerName String?  @db.VarChar(200)
  recommendedSubProjection Float?
  autoSubstituted          Boolean  @default(false)

  // Notification tracking
  notificationSent     Boolean  @default(false)
  notificationSentAt   DateTime?
  pushToken            String?  @db.VarChar(500)
  urgencyLevel         String   @db.VarChar(20) @default("medium") // 'low', 'medium', 'high', 'critical'

  // User response
  userAcknowledged     Boolean  @default(false)
  acknowledgedAt       DateTime?
  userSubstituted      Boolean  @default(false)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId, week, season])
  @@index([gameTime])
  @@index([notificationSent])
  @@index([injuredPlayerId])
  @@map("injury_alerts")
}
