name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-api:
    name: Deploy API to Railway
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: railway up --service api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Run database migrations
        run: railway run --service api pnpm --filter database exec prisma migrate deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-web:
    name: Deploy Web to Vercel
    runs-on: ubuntu-latest
    needs: deploy-api  # Wait for API to deploy first

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./apps/web
          vercel-args: '--prod'

  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web]

    steps:
      - name: Check API Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.API_URL }}/health)
          if [ $response != "200" ]; then
            echo "API health check failed with status code: $response"
            exit 1
          fi
          echo "API health check passed"

      - name: Check Web Deployment
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.WEB_URL }})
          if [ $response != "200" ]; then
            echo "Web health check failed with status code: $response"
            exit 1
          fi
          echo "Web health check passed"

      - name: Send deployment notification
        if: always()
        run: |
          echo "Deployment completed. API: ${{ secrets.API_URL }} | Web: ${{ secrets.WEB_URL }}"
